<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>海报画廊</title>
	<link rel="stylesheet" href="css/main.css">
</head>
<body>

<!-- 1.先修改模板 -->
<div class="wrap" onselectstart="return false" id="template">
	<!-- photo 负责平移 -->
	<div class="photo photo_front" onclick="turn(this)" id="photo_{{index}}">
		<!-- photo_wrap 负责翻转 -->
		<div class="photo_wrap">
			<div class="side photo_front">
				<p class="imgbox">
					<img src="photo/{{img}}" alt="">
				</p>
				<p class="caption">{{caption}}</p>
			</div>
			<div class="side photo_back">
				<div class="desc">
					<p>{{desc}}</p>
				</div>
			</div>
		</div><!-- photo_wrap end -->
	</div><!-- photo end -->
</div><!-- wrap end -->
<script src="photo/data.js"></script>
<script>
	// 通用函数
	function g(sel){
		if(sel.substr(0,1) == '.'){
			return document.getElementsByClassName(sel.substr(1));
		}
		return document.getElementById(sel);
	}
	// 点击图片翻转
	function turn( elms ){
		var cls = elms.className;
		var n = elms.id.split('_')[1];

		if(!/photo_center/.test(cls)){
			return rsort(n);
		}

		if( /photo_front/.test(cls)){
			cls = cls.replace('photo_front','photo_back');
			g('nav_'+n).className += ' back';
		}else{
			cls = cls.replace('photo_back','photo_front');
			g('nav_'+n).className = g('nav_'+n).className.replace(/\s*back\s*/,'');
		}
		return elms.className = cls;
	}
	// 计算左右区域的范围

	function range(){
		var range = { left:{x:[],y:[]},right:{x:[],y:[]} };
		
		var wrap = {
			w:g('template').clientWidth,
			h:g('template').clientHeight
		}
		var photo = {
			w:g('.photo')[0].offsetWidth,
			h:g('.photo')[0].cffsetHeight
		}
		range.wrap = wrap;
		range.photo = photo;

		range.left.x = [0-photo.w, wrap.w/2-photo.w];
		range.left.y = [0-photo.h, wrap.h];

		range.right.x = [wrap.w/2+photo.w, wrap.w ];
		range.right.y = range.left.y;

		return range;
	}

	// 排序海报
	function rsort( n ){
		var _photo = g('.photo');
		var photos = [];

		for(var i = 0; i < _photo.length; i++){
			_photo[i].className = _photo[i].className.replace(/\s*photo_center\s*/,' ');
			_photo[i].className = _photo[i].className.replace(/\s*photo_front\s*/,' ');
			_photo[i].className = _photo[i].className.replace(/\s*photo_back\s*/,' ');
			
			_photo[i].className += 'photo_front';
			_photo[i].style.left = '';
			_photo[i].style.top  = '';
			_photo[i].style['transform'] = 'rotate(360deg) scale(1.1)';
			photos.push(_photo[i]);
		}
		var centerPhoto = g('photo_'+n);
		centerPhoto.className += ' photo_center';
		
		var dots = g('.dots');
		for(var i = 0; i < dots.length; i++){
			dots[i].className = dots[i].className.replace(/\s*current\s*/,' ');
			dots[i].className = dots[i].className.replace(/\s*back\s*/,' ');
			dots[i].className = dots[i].className.replace(/\s*icon-rotateleft iconfont\s*/,' ');
		}
		
		g('nav_'+n).className += ' current icon-rotateleft iconfont ';
		centerPhoto = photos.splice(n, 1)[0];

		// 把剩下的海报分为2个部分
		var photo_l = photos.splice(0, Math.ceil(photos.length/2));
		var photo_r = photos;
		
		var ranges = range();

		for(var s in photo_l){
			var photo = photo_l[s];

			photo.style.left = random(ranges.left.x) +'px';
			photo.style.top = random(ranges.left.y) +'px';
			photo.style['transform'] = 'rotate('+random([-150,150])+'deg) scale(1)';
		}
		for(var s in photo_r){
			var photo = photo_r[s];

			photo.style.left = random(ranges.right.x) +'px';
			photo.style.top = random(ranges.right.y) +'px';
			photo.style['transform'] = 'rotate('+random([-150,150])+'deg) scale(1)';
		}
	}
	// 随机数
	function random( range ){
		var max = Math.max(range[0],range[1]);
		var min = Math.min(range[0],range[1]);

		var diff = max - min;
		var number = Math.round( Math.random() * diff + min );
		return number;
	}

	// 2. 把数据加入到HTML内
	var data = data;
	function addPhoto(){
		var oWrop = g('template').innerHTML;

		var html = [];
		var nav = [];
		// 遍历数据
		for(var i in data){
			var photo_item = oWrop.replace('{{index}}',i)
					.replace('{{img}}',data[i].img)
					.replace('{{caption}}',data[i].caption)
					.replace('{{desc}}',data[i].desc);
			html.push(photo_item);
			nav.push('<span id="nav_'+i+'" class="dots icon-rotateleft iconfont" onclick="turn( g(\'photo_'+i+'\') )"></span>');
		}
		html.push('<div class="nav">'+nav.join('')+'</div>');
		g('template').innerHTML = html.join('');
		rsort( random([0,data.length-1]) );
	}
	addPhoto();
</script>
</body>
</html>